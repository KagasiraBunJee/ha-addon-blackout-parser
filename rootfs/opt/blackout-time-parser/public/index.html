<!doctype html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <title>Blackout Time Parser</title>
  <style>
    :root { color-scheme: light; font-family: "Helvetica Neue", Arial, sans-serif; background: #0f172a; color: #e2e8f0; }
    body { margin: 0; padding: 24px; max-width: 960px; }
    h1 { margin-top: 0; }
    .card { background: #111827; border: 1px solid #1f2937; border-radius: 12px; padding: 16px; margin-bottom: 16px; box-shadow: 0 10px 40px rgba(0,0,0,0.25); }
    .grid { display: grid; gap: 12px; grid-template-columns: repeat(auto-fit,minmax(240px,1fr)); }
    label { display: block; margin-bottom: 8px; font-weight: 600; }
    textarea { width: 100%; min-height: 140px; background: #0b1222; color: #e2e8f0; border: 1px solid #1f2937; border-radius: 8px; padding: 10px; }
    button { background: linear-gradient(135deg,#22d3ee,#6366f1); color: #0b1222; border: none; border-radius: 10px; padding: 10px 16px; font-weight: 700; cursor: pointer; }
    button:hover { opacity: 0.95; }
    .pill { display: inline-block; padding: 4px 8px; border-radius: 999px; background: #1f2937; font-size: 12px; }
    table { width: 100%; border-collapse: collapse; }
    th, td { text-align: left; padding: 8px; border-bottom: 1px solid #1f2937; }
    small { color: #94a3b8; }
  </style>
</head>
<body>
  <h1>Blackout Time Parser</h1>
  <div class="grid">
    <div class="card">
      <h3>Configuration</h3>
      <div id="config"></div>
    </div>
    <div class="card">
      <h3>Current Schedule</h3>
      <div id="schedule"></div>
    </div>
    <div class="card">
      <h3>All Schedules</h3>
      <div id="all-schedules"></div>
    </div>
  </div>

  <div class="card">
    <h3>Test Parse</h3>
    <p>Paste a Telegram post to validate parsing without waiting for the channel webhook.</p>
    <label for="text">Message</label>
    <textarea id="text" placeholder="Paste Telegram post text here"></textarea>
    <div style="margin-top:10px;">
      <button id="parse">Parse</button>
      <button id="reset" style="margin-left:8px;background:#f97316;color:#0b1222;">Reset schedules</button>
      <span id="parse-status" class="pill"></span>
    </div>
    <pre id="parse-result"></pre>
  </div>

  <script>
    const apiBase = (() => {
      const m = window.location.pathname.match(/^\/api\/hassio_ingress\/[^/]+/);
      return m ? m[0] : '';
    })();

    async function loadStatus() {
      const res = await fetch(`${apiBase}/api/status`);
      const data = await res.json();
      renderConfig(data.config);
      renderSchedule(data.state?.schedules, data.config.timezone, data.state?.next_window);
      renderAllSchedules(data.state?.schedules);
    }

    function renderConfig(cfg) {
      const el = document.getElementById('config');
      el.innerHTML = `
        <div><strong>Channel:</strong> ${cfg.telegram_channel || 'not set'}</div>
        <div><strong>Prefix:</strong> ${cfg.prefix}</div>
        <div><strong>Switch:</strong> ${cfg.switch_entity || 'not set'}</div>
        <div><strong>Switches:</strong> ${cfg.switch_entities && cfg.switch_entities.length ? cfg.switch_entities.join(', ') : '—'}</div>
        <div><strong>Timezone:</strong> ${cfg.timezone}</div>
        <div><strong>Telegram mode:</strong> ${cfg.telegram_mode}</div>
        <div><strong>LLM:</strong> ${cfg.llm_provider}</div>
        <div><strong>Provider choice:</strong> ${cfg.provider || 'auto'}</div>
        <div><strong>Loop seconds:</strong> ${cfg.loop_seconds}</div>
        <div><strong>Scheduled jobs:</strong> ${cfg.scheduled_jobs ?? 0}</div>
        <div><strong>Hint:</strong> ${cfg.message_hint || '—'}</div>
      `;
    }

    function renderSchedule(schedules, timezone, nextWindow) {
      const el = document.getElementById('schedule');
      const today = new Date().toISOString().slice(0, 10);
      const todaySchedule = schedules && schedules[today];
      if (!todaySchedule) {
        el.innerHTML = '<small>No schedule parsed yet.</small>';
        return;
      }
      const rows = todaySchedule.ranges.map(r => `<tr><td>${r.start}</td><td>${r.end}</td></tr>`).join('');
      const next = nextWindow && nextWindow.date === today ? nextWindow : null;
      const nextHtml = next
        ? `<div><strong>Next window:</strong> ${next.range.start} - ${next.range.end}</div>`
        : '<div><strong>Next window:</strong> none</div>';
      el.innerHTML = `
        <div><span class="pill">${todaySchedule.source}</span></div>
        <div><strong>Date:</strong> ${todaySchedule.date}</div>
        <div><strong>Prefix:</strong> ${todaySchedule.prefix}</div>
        ${nextHtml}
        <table><thead><tr><th>Start</th><th>End</th></tr></thead><tbody>${rows}</tbody></table>
        <small>Parsed at ${todaySchedule.parsed_at}</small>
      `;
    }

    function renderAllSchedules(schedules) {
      const el = document.getElementById('all-schedules');
      if (!schedules || Object.keys(schedules).length === 0) {
        el.innerHTML = '<small>No schedules stored.</small>';
        return;
      }
      const items = Object.entries(schedules)
        .sort(([a], [b]) => (a > b ? 1 : -1))
        .map(([date, sched]) => {
          const rows = (sched.ranges || [])
            .map(r => `<li>${r.start} - ${r.end}</li>`)
            .join('');
          return `<div style="margin-bottom:10px;"><strong>${date}</strong><ul>${rows}</ul></div>`;
        })
        .join('');
      el.innerHTML = items;
    }

    document.getElementById('parse').addEventListener('click', async () => {
      const text = document.getElementById('text').value;
      const statusEl = document.getElementById('parse-status');
      statusEl.textContent = 'Parsing...';
      try {
        console.log('[ui] sending test-parse');
        const res = await fetch(`${apiBase}/api/test-parse`, {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ text }),
        });
        const raw = await res.text();
        let payload = null;
        try {
          payload = JSON.parse(raw);
        } catch (e) {
          payload = { parse_error: String(e), raw };
        }
        console.log('[ui] test-parse response', payload);
        statusEl.textContent = res.ok ? 'Done' : `Error ${res.status}`;
        document.getElementById('parse-result').textContent = JSON.stringify(payload, null, 2);
      } catch (err) {
        console.error('[ui] test-parse failed', err);
        statusEl.textContent = 'Error';
        document.getElementById('parse-result').textContent = String(err);
      }
      loadStatus();
    });

    document.getElementById('reset').addEventListener('click', async () => {
      const statusEl = document.getElementById('parse-status');
      statusEl.textContent = 'Resetting...';
      try {
        const res = await fetch(`${apiBase}/api/reset`, { method: 'POST' });
        const raw = await res.text();
        let payload = null;
        try { payload = JSON.parse(raw); } catch { payload = { parse_error: 'reset parse failed', raw }; }
        console.log('[ui] reset response', payload);
        statusEl.textContent = res.ok ? 'Reset' : `Error ${res.status}`;
      } catch (err) {
        console.error('[ui] reset failed', err);
        statusEl.textContent = 'Reset error';
      }
      loadStatus();
    });

    loadStatus();
    setInterval(loadStatus, 15000);
  </script>
</body>
</html>
